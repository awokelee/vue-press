(window.webpackJsonp=window.webpackJsonp||[]).push([[134],{250:function(t,s,e){"use strict";e.r(s);var a=e(0),r=Object(a.a)({},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"content"},[t._m(0),e("p",[t._v("当 npm script 不断累积、膨胀的时候，全部放在 package.json 里面可能并不是个好主意，因为这样会导致 package.json 糟乱，可读性降低。")]),e("p",[t._v("借助 "),e("a",{attrs:{href:"https://github.com/testdouble/scripty",target:"_blank",rel:"noopener noreferrer"}},[t._v("scripty"),e("OutboundLink")],1),t._v(" 我们可以将 npm script 剥离到单独的文件中，从而把复杂性隔到单独的模块里面，让代码整体看起来更加清晰。")]),e("p",[t._v("示例项目中的覆盖率相关的 npm script 占据了很大的篇幅，如下：")]),t._m(1),e("p",[t._v("如果要隔离复杂性，我们可以考虑从 cover 相关的 script 入手，具体操作步骤如下：")]),t._m(2),t._m(3),t._m(4),t._m(5),e("p",[t._v("先创建两层的目录，因为我们计划把 cover 脚本写成多个，方便单独去执行，这里命名为 scripts 是 scripty 默认的，实际上是可以自定义的。")]),t._m(6),e("p",[t._v("然后创建空白的脚本文件，因为有了单独的脚本，我们可以把原来的 precover、cover、postcover、cover:archive、cover:cleanup 合并到一个文件中。")]),e("p",[t._v("按照 scripty 的默认约定，npm script 命令和上面各文件的对应关系如下：")]),t._m(7),t._m(8),t._m(9),t._m(10),e("p",[t._v("准备好目录和文件之后，接下来需要给脚本填充内容，脚本内容如下（因为脚本使用的是 bash，所以直接忽略了跨平台兼容的处理，跨平台兼容脚本最好使用 Node.js 编写，下节会介绍）：")]),t._m(11),t._m(12),t._m(13),t._m(14),t._m(15),t._m(16),e("p",[t._v("细心的同学可能注意到了，在 shell 脚本里面是可以随意使用 npm 的内置变量和自定义变量的。")]),t._m(17),e("p",[t._v("主要改动是清理 cover:* 命令，接入 scripty，具体的 diff 如下：")]),t._m(18),e("p",[t._v("这里我们只保留了 cover、cover:serve、cover:open 等 3 个命令，让它们都指向 scripty，调用哪个脚本都由 scripty 来处理。")]),t._m(19),e("p",[t._v("修改完毕之后，重新运行 npm run cover，不出意外的话，我们能得到和原来完全相同的结果，仔细观察运行的日志，会发现在代码执行前有段额外的输出，如下图中红色框中的内容，scripty 在实际执行的时候会把执行的命令内容打印出来，方便调试：")]),t._m(20),t._m(21),e("p",[t._v("scripty 比上面演示的要更强大，也支持通配符运行、脚本并行等特性、静默模式，如果有需求可以阅读官方的 "),e("a",{attrs:{href:"https://github.com/testdouble/scripty#advanced-usage",target:"_blank",rel:"noopener noreferrer"}},[t._v("README.md"),e("OutboundLink")],1),t._v("，毕竟咱们已经入门了，不是么？")]),e("hr"),e("blockquote",[e("p",[t._v("本节用到的代码见 "),e("a",{attrs:{href:"https://github.com/wangshijun/automated-workflow-with-npm-script/tree/07-manage-complexity-using-scripty",target:"_blank",rel:"noopener noreferrer"}},[t._v("GitHub"),e("OutboundLink")],1),t._v("，想边看边动手练习的同学可以拉下来自己改，注意切换到正确的分支 "),e("code",[t._v("07-manage-complexity-using-scripty")]),t._v("。")])]),e("hr")])},[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"_3-2-把庞大的-npm-script-拆到单独文件中"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-把庞大的-npm-script-拆到单独文件中","aria-hidden":"true"}},[this._v("#")]),this._v(" 3.2 把庞大的 npm script 拆到单独文件中")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[t._v("  "),e("span",{attrs:{class:"token property"}},[t._v('"scripts"')]),e("span",{attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{attrs:{class:"token property"}},[t._v('"cover"')]),e("span",{attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{attrs:{class:"token string"}},[t._v('"nyc --reporter=html npm test"')]),e("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{attrs:{class:"token property"}},[t._v('"cover:cleanup"')]),e("span",{attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{attrs:{class:"token string"}},[t._v('"rimraf coverage && rimraf .nyc_output"')]),e("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{attrs:{class:"token property"}},[t._v('"cover:archive"')]),e("span",{attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{attrs:{class:"token string"}},[t._v('"cross-var \\"make-dir coverage_archive/$npm_package_version && cpr coverage/* coverage_archive/$npm_package_version -o\\""')]),e("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{attrs:{class:"token property"}},[t._v('"cover:serve"')]),e("span",{attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{attrs:{class:"token string"}},[t._v('"cross-var http-server coverage_archive/$npm_package_version -p $npm_package_config_port"')]),e("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{attrs:{class:"token property"}},[t._v('"cover:open"')]),e("span",{attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{attrs:{class:"token string"}},[t._v('"cross-var opn http://localhost:$npm_package_config_port"')]),e("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{attrs:{class:"token property"}},[t._v('"precover"')]),e("span",{attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{attrs:{class:"token string"}},[t._v('"npm run cover:cleanup"')]),e("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{attrs:{class:"token property"}},[t._v('"postcover"')]),e("span",{attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{attrs:{class:"token string"}},[t._v('"npm-run-all cover:archive --parallel cover:serve cover:open"')]),t._v("\n  "),e("span",{attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"_1-安装依赖"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装依赖","aria-hidden":"true"}},[this._v("#")]),this._v(" 1. 安装依赖")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{attrs:{class:"token function"}},[this._v("npm")]),this._v(" i scripty -D\n"),s("span",{attrs:{class:"token comment"}},[this._v("# npm install scripty --save-dev")]),this._v("\n"),s("span",{attrs:{class:"token comment"}},[this._v("# yarn add scripty -D")]),this._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"_2-准备目录和文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-准备目录和文件","aria-hidden":"true"}},[this._v("#")]),this._v(" 2. 准备目录和文件")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{attrs:{class:"token function"}},[this._v("mkdir")]),this._v(" -p scripts/cover\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{attrs:{class:"token function"}},[this._v("touch")]),this._v(" scripts/cover.sh\n"),s("span",{attrs:{class:"token function"}},[this._v("touch")]),this._v(" scripts/cover/serve.sh\n"),s("span",{attrs:{class:"token function"}},[this._v("touch")]),this._v(" scripts/cover/open.sh\n")])])])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("table",[e("thead",[e("tr",[e("th",[t._v("命令")]),e("th",[t._v("文件")]),e("th",[t._v("备注")])])]),e("tbody",[e("tr",[e("td",[t._v("cover")]),e("td",[t._v("scripts/cover.sh")]),e("td",[t._v("内含 precover、postcover 的逻辑")])]),e("tr",[e("td",[t._v("cover:serve")]),e("td",[t._v("scripts/cover/serve.sh")]),e("td",[t._v("启动服务")])]),e("tr",[e("td",[t._v("cover:open")]),e("td",[t._v("scripts/cover/open.sh")]),e("td",[t._v("打开预览")])])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("特别注意的是，给所有脚本增加可执行权限是必须的，否则 scripty 执行时会报错")]),this._v("，我们可以给所有的脚本增加可执行权限：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{attrs:{class:"token function"}},[this._v("chmod")]),this._v(" -R a+x scripts/**/*.sh\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"_3-修改-scripty-脚本"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-修改-scripty-脚本","aria-hidden":"true"}},[this._v("#")]),this._v(" 3. 修改 scripty 脚本")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("scripts/cover.sh")]),this._v(" 内容如下（cleanup --\x3e cover --\x3e archive --\x3e preview）：")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{attrs:{class:"token comment"}},[t._v("#!/usr/bin/env bash")]),t._v("\n\n"),e("span",{attrs:{class:"token comment"}},[t._v("# remove old coverage reports")]),t._v("\nrimraf coverage "),e("span",{attrs:{class:"token operator"}},[t._v("&&")]),t._v(" rimraf .nyc_output\n\n"),e("span",{attrs:{class:"token comment"}},[t._v("# run test and collect new coverage")]),t._v("\nnyc --reporter"),e("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("html "),e("span",{attrs:{class:"token function"}},[t._v("npm")]),t._v(" run "),e("span",{attrs:{class:"token function"}},[t._v("test")]),t._v("\n\n"),e("span",{attrs:{class:"token comment"}},[t._v("# achive coverage report by version")]),t._v("\n"),e("span",{attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p coverage_archive/"),e("span",{attrs:{class:"token variable"}},[t._v("$npm_package_version")]),t._v("\n"),e("span",{attrs:{class:"token function"}},[t._v("cp")]),t._v(" -r coverage/* coverage_archive/"),e("span",{attrs:{class:"token variable"}},[t._v("$npm_package_version")]),t._v("\n\n"),e("span",{attrs:{class:"token comment"}},[t._v("# open coverage report for preview")]),t._v("\nnpm-run-all --parallel cover:serve cover:open\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("scripts/cover/serve.sh")]),this._v(" 内容如下：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{attrs:{class:"token comment"}},[this._v("#!/usr/bin/env bash")]),this._v("\n\nhttp-server coverage_archive/"),s("span",{attrs:{class:"token variable"}},[this._v("$npm_package_version")]),this._v(" -p "),s("span",{attrs:{class:"token variable"}},[this._v("$npm_package_config_port")]),this._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("scripts/cover/open.sh")]),this._v(" 内容如下（这里有个 sleep，是为了确保文件系统写入完成）：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{attrs:{class:"token comment"}},[this._v("#!/usr/bin/env bash")]),this._v("\n\n"),s("span",{attrs:{class:"token function"}},[this._v("sleep")]),this._v(" 1\nopn http://localhost:"),s("span",{attrs:{class:"token variable"}},[this._v("$npm_package_config_port")]),this._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"_4-修改-package-json"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-修改-package-json","aria-hidden":"true"}},[this._v("#")]),this._v(" 4. 修改 package.json")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-patch extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[this._v('   "scripts": {\n     "test": "cross-env NODE_ENV=test mocha tests/",\n-    "cover": "nyc --reporter=html npm test",\n-    "cover:cleanup": "rimraf coverage && rimraf .nyc_output",\n-    "cover:archive": "cross-var \\"make-dir coverage_archive/$npm_package_version && cpr coverage/* coverage_archive/$npm_package_version -o\\"",\n-    "cover:serve": "cross-var http-server coverage_archive/$npm_package_version -p $npm_package_config_port",\n-    "cover:open": "cross-var opn http://localhost:$npm_package_config_port",\n-    "precover": "npm run cover:cleanup",\n-    "postcover": "npm-run-all cover:archive --parallel cover:serve cover:open"\n+    "cover": "scripty",\n+    "cover:serve": "scripty",\n+    "cover:open": "scripty"\n   },\n')])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"_5-实际测试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-实际测试","aria-hidden":"true"}},[this._v("#")]),this._v(" 5. 实际测试")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2017/12/7/1602e70a1b4df91b?w=874&h=711&f=png&s=94680",alt:""}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"高级技巧"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#高级技巧","aria-hidden":"true"}},[this._v("#")]),this._v(" 高级技巧")])}],!1,null,null,null);s.default=r.exports}}]);